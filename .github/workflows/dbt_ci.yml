name: DBT CI/CD Pipeline

on:
  push:
    branches:
      - PelaezFrancisco-patch-1  # O la rama que uses para producciÃ³n
  pull_request:

jobs:
  dbt_tests:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ› ï¸ Clonar el repositorio
        uses: actions/checkout@v3

      - name: ðŸ“¥ Configurar DBT y autenticaciÃ³n en BigQuery
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ðŸ”¹ Instalar DBT
        run: pip install dbt-bigquery

      - name: ðŸ”‘ Configurar credenciales de BigQuery
        run: echo "$GOOGLE_CREDENTIALS" > /tmp/keyfile.json
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: ðŸ—ï¸ Configurar DBT Profile
        run: |
          mkdir -p ~/.dbt
          dbt deps
          echo "default:
            outputs:
              dev:
                type: bigquery
                method: service-account
                project: dbt-globant
                dataset: dbt_fpelaez_globant
                location: us-west1
                threads: 4
                keyfile: /tmp/keyfile.json
            target: dev" > ~/.dbt/profiles.yml

      - name: âœ… Ejecutar pruebas unitarias con DBT
        run: dbt test

      - name: ðŸš€ Ejecutar y desplegar modelos en BigQuery
        run: dbt run
